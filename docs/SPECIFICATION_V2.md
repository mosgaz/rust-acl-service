# Техническое задание v2.0
## ACL-сервис (Authorization as a Service)

## 1. Цель документа
Данный документ фиксирует обновленное ТЗ v2.0 для `rust-acl-service` с поэтапной реализацией.

Основные принципы:
- быстрый запуск через **MVP без избыточной сложности**;
- сохранение совместимости контракта для последующего расширения;
- перенос продвинутых требований в следующие фазы;
- использование рекомендаций из `docs/MVP_REVIEW.md`.

---

## 2. Контекст и ограничения

### 2.1. Что уже известно
По результатам ревью:
- текущая спецификация v1.0 описывает целевое состояние, но перегружает первый релиз;
- репозиторий находился в стадии pre-implementation;
- для старта рекомендованы RBAC-only, один API-протокол и PostgreSQL без Redis.

### 2.2. Границы ответственности
ACL-сервис отвечает только за **Authorization (AuthZ)**:
- принимает идентификатор субъекта, действие и ресурс;
- возвращает решение `allow/deny`;
- не занимается аутентификацией, выпуском токенов и хранением секретов.

---

## 3. Целевая архитектура по этапам

### 3.1. Фаза 1 — MVP (обязательная)
**Цель:** вывести рабочий сервис в эксплуатацию с минимальными рисками.

**Функциональный scope:**
1. Модель доступа: только **RBAC**.
2. API-протокол: только **REST** (v1 endpoints).
3. Хранилище: только **PostgreSQL**.
4. Check API:
   - `POST /v1/check`
   - вход: `actor_id`, `action`, `resource`
   - выход: `allow: bool`
5. Admin API (минимум):
   - роли;
   - права ролей;
   - назначения ролей пользователям.

**Эксплуатационный минимум:**
- `/health` и `/ready`;
- структурированные логи;
- метрики: `request_count`, `request_latency`;
- поведение по умолчанию: **fail closed**.

**Что НЕ входит в MVP:**
- ABAC;
- namespaces;
- Redis-кэш и сложная инвалидация;
- gRPC;
- circuit breaker/retry policy;
- обязательный целевой benchmark 10k RPS.

### 3.2. Фаза 2 — Production hardening
**Цель:** повысить надежность и наблюдаемость без изменения базового контракта.

**Добавляется:**
- расширенные метрики и трассировка (OpenTelemetry);
- безопасное администрирование (аудит изменений, ротация ключей доступа к Admin API);
- улучшения производительности (индексы, оптимизация запросов, профилирование);
- базовый SLO на latency и error-rate;
- регламент резервного копирования и восстановления.

**Ограничения фазы 2:**
- ABAC и multi-protocol допускаются только после стабилизации MVP-нагрузки.

### 3.3. Фаза 3 — Функциональное расширение
**Цель:** добавить гибкость политик и интеграционные возможности.

**Добавляется:**
- ABAC как расширение модели принятия решений;
- опциональные namespaces;
- gRPC API (параллельно REST при доказанной необходимости);
- клиентская библиотека (Rust) с кэшированием и middleware;
- опциональный Redis как L2-кэш для масштабирования.

### 3.4. Фаза 4 — Scale & resilience
**Цель:** подготовка к высокой нагрузке и отказоустойчивости.

**Добавляется:**
- circuit breaker, retry policy, adaptive timeouts;
- нагрузочные цели уровня 10k RPS (или иные, основанные на фактическом профиле);
- chaos/soak тестирование;
- multi-region/DR сценарии (при необходимости бизнеса).

---

## 4. Контракты API (v2.0 baseline)

### 4.1. Check API
`POST /v1/check`

**Request (MVP):**
```json
{
  "actor_id": "user-uuid",
  "action": "read",
  "resource": "document:123"
}
```

**Response:**
```json
{
  "allow": true
}
```

### 4.2. Эволюция контракта
В фазе 3 допускается расширение запроса полем `context` (для ABAC), при сохранении обратной совместимости:
- поле опционально;
- семантика текущего RBAC не ломается;
- старые клиенты продолжают работать.

---

## 5. Требования к данным (MVP)

Минимальная схема:
- `roles`;
- `permissions`;
- `role_permissions`;
- `actor_roles`.

Требования:
- миграции обязательны;
- уникальные ограничения на критичные связи;
- индексы на lookup-поля (`actor_id`, `role_id`, `permission`).

---

## 6. Definition of Done по фазам

### 6.1. DoD — Фаза 1 (MVP)
- есть рабочий Rust-сервис (`Cargo.toml`, `src/`);
- реализованы миграции БД;
- реализованы `POST /v1/check` и минимальный Admin API;
- есть интеграционные тесты (happy-path + deny-path);
- есть `docker-compose` для локального запуска с PostgreSQL;
- есть краткая инструкция запуска и `curl`-примеры.

### 6.2. DoD — Фаза 2
- метрики и трассировка покрывают ключевые операции;
- аудит административных изменений включен;
- зафиксирован и достигается SLO;
- выполнены тесты восстановления после отказов БД/сети.

### 6.3. DoD — Фаза 3
- ABAC введен без breaking changes в Check API;
- добавлен gRPC (если подтверждено интеграционными сценариями);
- клиентская библиотека стабилизирована и покрыта тестами.

### 6.4. DoD — Фаза 4
- проведены нагрузочные/длительные/хаос-тесты;
- подтверждены целевые показатели latency/throughput/availability;
- отработаны сценарии деградации и восстановления.

---

## 7. Реестр рисков и меры

1. **Риск переусложнения MVP**
   - Мера: freeze scope фазы 1, все расширения — только через фазы 2+.

2. **Риск ранней оптимизации производительности**
   - Мера: сначала профилирование и реальные метрики, затем Redis/сложные паттерны.

3. **Риск ломки клиентов при расширении API**
   - Мера: additive-only изменения, versioning, контрактные тесты.

4. **Риск смешения AuthN и AuthZ**
   - Мера: в интерфейсах и коде строго разделять ответственность.

---

## 8. План внедрения (рекомендуемый)

- **Sprint 1–2:** Фаза 1 (MVP), запуск в dev/stage.
- **Sprint 3:** стабилизация и исправления по итогам интеграций.
- **Sprint 4–5:** Фаза 2 (hardening).
- **Далее:** фазы 3–4 только при подтвержденной потребности (продуктовые сценарии + метрики).

---

## 9. Критерий принятия ТЗ v2.0
ТЗ считается принятым, если:
- согласован поэтапный scope;
- MVP фиксируется как обязательный минимум без ABAC/Redis/gRPC;
- расширения оформлены отдельными фазами с явным DoD.
